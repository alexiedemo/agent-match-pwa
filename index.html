<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Match</title>
  <link rel="manifest" href="/manifest.json" />
  <script defer src="https://cdn.tailwindcss.com"></script>
  <style>input, select, textarea { color-scheme: light dark; }</style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <main class="max-w-2xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Agent Match</h1>
      <button id="btnNotify" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">Enable alerts</button>
    </header>

    <section class="p-4 rounded-2xl bg-zinc-900 shadow">
      <h2 class="text-lg font-semibold mb-3">Add Buyer</h2>
      <form id="buyerForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1">Buyer name</label>
          <input id="buyerName" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="e.g. Smith Family" required />
        </div>
        <div>
          <label class="block text-sm mb-1">Contact (optional)</label>
          <input id="buyerContact" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="email or mobile" />
        </div>
        <div>
          <label class="block text-sm mb-1">Suburbs (comma-separated)</label>
          <input id="buyerSuburbs" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="Brinsmead, Redlynch" required />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Min price</label>
            <input id="priceMin" type="number" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="500000" />
          </div>
          <div>
            <label class="block text-sm mb-1">Max price</label>
            <input id="priceMax" type="number" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="800000" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Min beds</label>
            <input id="bedsMin" type="number" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="3" />
          </div>
          <div>
            <label class="block text-sm mb-1">Property types</label>
            <select id="propType" class="w-full px-3 py-2 rounded-xl bg-zinc-800">
              <option value="any">Any</option>
              <option value="house">House</option>
              <option value="unit">Unit/Apartment</option>
              <option value="townhouse">Townhouse</option>
              <option value="acreage">Acreage</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Keywords (optional)</label>
          <input id="keywords" class="w-full px-3 py-2 rounded-xl bg-zinc-800" placeholder="renovator, dual living, pool" />
        </div>
        <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Save buyer</button>
      </form>
    </section>

    <section class="p-4 rounded-2xl bg-zinc-900 shadow">
      <h2 class="text-lg font-semibold mb-3">Buyers</h2>
      <div id="buyerList" class="space-y-3"></div>
    </section>

    <footer class="opacity-70 text-xs">Cairns-first matching • Background alerts • Built for iPhone</footer>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);

    async function getConfig(){
      const r = await fetch('/api/config');
      return r.json();
    }

    async function ensureServiceWorker(){
      if(!('serviceWorker' in navigator)) return false;
      const reg = await navigator.serviceWorker.register('/sw.js');
      return reg;
    }

    async function enablePush(){
      try {
        const permission = await Notification.requestPermission();
        if(permission !== 'granted'){ alert('Notifications not enabled.'); return; }
        const reg = await ensureServiceWorker();
        const { publicKey } = await getConfig();
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });
        await fetch('/api/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
        alert('Push notifications enabled. Add this app to your Home Screen for best results.');
      } catch(err){
        console.error(err); alert('Failed to enable notifications.');
      }
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    $('#btnNotify').addEventListener('click', enablePush);

    async function loadBuyers(){
      const r = await fetch('/api/buyers');
      const data = await r.json();
      const list = $('#buyerList');
      list.innerHTML = '';
      if(!data.length){ list.innerHTML = '<div class="opacity-70">No buyers yet.</div>'; return; }
      for(const b of data){
        const el = document.createElement('div');
        el.className = 'p-3 rounded-xl bg-zinc-800 flex items-start justify-between gap-3';
        el.innerHTML = `
          <div>
            <div class="font-semibold">${b.name}</div>
            <div class="text-xs opacity-80">${b.contact || ''}</div>
            <div class="text-xs opacity-80 mt-1">${b.suburbs.join(', ')} • $${b.priceMin || '—'} - $${b.priceMax || '—'} • ${b.bedsMin||'—'}+ beds • ${b.propType}</div>
            <div class="text-xs opacity-80">Keywords: ${b.keywords?.join(', ') || '—'}</div>
          </div>
          <button data-id="${b.id}" class="btnDel px-3 py-2 rounded-lg bg-red-600 hover:bg-red-500">Delete</button>
        `;
        list.appendChild(el);
      }
      for(const btn of document.querySelectorAll('.btnDel')){
        btn.addEventListener('click', async (e)=>{
          const id = e.target.getAttribute('data-id');
          if(!confirm('Delete buyer?')) return;
          await fetch('/api/buyers?id='+encodeURIComponent(id), { method: 'DELETE' });
          loadBuyers();
        });
      }
    }

    $('#buyerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        name: $('#buyerName').value.trim(),
        contact: $('#buyerContact').value.trim(),
        suburbs: $('#buyerSuburbs').value.split(',').map(s=>s.trim()).filter(Boolean),
        priceMin: +($('#priceMin').value || 0) || null,
        priceMax: +($('#priceMax').value || 0) || null,
        bedsMin: +($('#bedsMin').value || 0) || null,
        propType: $('#propType').value || 'any',
        keywords: $('#keywords').value.split(',').map(s=>s.trim()).filter(Boolean)
      };
      await fetch('/api/buyers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      e.target.reset();
      loadBuyers();
      alert('Buyer saved. Background checker runs every 10 minutes.');
    });

    loadBuyers();
  </script>
</body>
</html>
